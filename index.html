<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Панель учета аккаунтов</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    body {
      background: linear-gradient(rgba(10, 11, 26, 0.9), rgba(10, 11, 26, 0.9)), url('https://images.unsplash.com/photo-1605733513597-a8f8343a1485?q=80&w=1920&auto=format&fit=crop') no-repeat center center fixed;
      background-size: cover;
      color: #E0E7FF;
      font-family: 'Inter', sans-serif;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
      animation: fadeIn 1s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    header {
      background: rgba(20, 25, 60, 0.7);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0, 212, 255, 0.2);
    }

    h1, h2, h3 {
      color: #ffffff;
      text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
    }

    button {
      background: linear-gradient(45deg, #00D4FF, #3B82F6);
      color: #ffffff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin: 6px;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 212, 255, 0.5);
    }

    select, input[type="text"], input[type="number"], input[type="email"], input[type="password"] {
      background: rgba(40, 45, 80, 0.5);
      color: #E0E7FF;
      border: 1px solid rgba(0, 212, 255, 0.3);
      padding: 10px;
      border-radius: 8px;
      margin: 6px;
      width: 100%;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #00D4FF;
      box-shadow: 0 0 8px rgba(0, 212, 255, 0.5);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: rgba(20, 25, 60, 0.7);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0, 212, 255, 0.2);
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(30, 35, 70, 0.5);
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid rgba(0, 212, 255, 0.2);
      padding: 12px;
      text-align: left;
    }

    th {
      background: linear-gradient(45deg, #3B82F6, #00D4FF);
      color: #ffffff;
    }

    tr {
      transition: background 0.2s;
    }

    tr:hover {
      background: rgba(0, 212, 255, 0.1);
    }

    .error {
      color: #FF6B6B;
      font-size: 0.9em;
      margin-top: 8px;
      text-shadow: 0 0 5px rgba(255, 107, 107, 0.5);
    }

    .hidden {
      display: none;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .view {
      display: block;
    }

    button.active {
      background: linear-gradient(45deg, #ffffff, #E0E7FF);
      color: #0A0B1A;
      box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
    }

    button.red {
      background: linear-gradient(45deg, #FF6B6B, #EF4444);
    }

    button.red:hover {
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5);
    }

    button.yellow {
      background: linear-gradient(45deg, #FBBF24, #F59E0B);
    }

    button.yellow:hover {
      box-shadow: 0 6px 20px rgba(251, 191, 36, 0.5);
    }

    button.green {
      background: linear-gradient(45deg, #34D399, #10B981);
    }

    button.green:hover {
      box-shadow: 0 6px 20px rgba(52, 211, 153, 0.5);
    }

    canvas {
      background: rgba(20, 25, 60, 0.7);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0, 212, 255, 0.2);
    }

    input[readonly] {
      background: rgba(60, 65, 100, 0.5);
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="auth" class="container card">
    <h2>Вход</h2>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Пароль" />
    <button id="login-btn">Войти</button>
    <button id="register-btn" class="green">Зарегистрироваться</button>
    <button id="reset-password-btn" class="yellow">Сбросить пароль</button>
    <div id="auth-error" class="error hidden"></div>
  </div>

  <div id="app" class="container hidden">
    <header>
      <h1>Панель учета аккаунтов</h1>
      <div style="margin-top: 8px;">
        <button id="transactions-btn" class="active">Транзакции</button>
        <button id="reports-btn">Отчеты</button>
        <select id="month-select"></select>
        <button id="add-month-btn" class="green">Добавить месяц</button>
        <button id="reset-data-btn" class="red">Сбросить балансы</button>
        <button id="logout-btn" class="yellow">Выйти</button>
      </div>
    </header>

    <div id="transactions" class="view card">
      <div>
        <h2 id="form-title">Добавить транзакцию</h2>
        <div class="grid">
          <select id="type">
            <option value="Покупка">Покупка</option>
            <option value="Продажа">Продажа</option>
            <option value="Перевод">Перевод</option>
            <option value="Пополнение">Пополнение</option>
            <option value="Списание">Списание</option>
          </select>
          <div id="purchase-sale-fields">
            <input id="category" type="text" placeholder="Категория (например, Закупка аккаунтов)" />
            <input id="amount" type="number" step="0.01" placeholder="Сумма (RUB/USDT)" />
            <select id="account">
              <option value="FunPay">FunPay (RUB)</option>
              <option value="CryptoBot">CryptoBot (USDT)</option>
              <option value="Binance">Binance (USDT)</option>
              <option value="Lolz">Lolz (RUB)</option>
            </select>
            <input id="quantity" type="number" placeholder="Количество аккаунтов" />
            <input id="note" type="text" placeholder="Примечание" />
          </div>
          <div id="transfer-fields" class="hidden">
            <select id="fromAccount">
              <option value="FunPay">FunPay (RUB)</option>
              <option value="CryptoBot">CryptoBot (USDT)</option>
              <option value="Binance">Binance (USDT)</option>
              <option value="Lolz">Lolz (RUB)</option>
            </select>
            <select id="toAccount">
              <option value="FunPay">FunPay (RUB)</option>
              <option value="CryptoBot">CryptoBot (USDT)</option>
              <option value="Binance">Binance (USDT)</option>
              <option value="Lolz">Lolz (RUB)</option>
            </select>
            <input id="amountFrom" type="number" step="0.01" placeholder="Сумма отправки (USDT/RUB)" />
            <input id="amountTo" type="number" step="0.01" placeholder="Сумма получения (RUB/USDT)" />
            <input id="exchangeRate" type="number" step="0.01" placeholder="Курс обмена (RUB за USDT)" readonly />
            <input id="transferNote" type="text" placeholder="Примечание" />
          </div>
          <div id="deposit-fields" class="hidden">
            <input id="depositAmount" type="number" step="0.01" placeholder="Сумма (RUB/USDT)" />
            <select id="depositAccount">
              <option value="FunPay">FunPay (RUB)</option>
              <option value="CryptoBot">CryptoBot (USDT)</option>
              <option value="Binance">Binance (USDT)</option>
              <option value="Lolz">Lolz (RUB)</option>
            </select>
            <input id="depositNote" type="text" placeholder="Примечание" />
          </div>
          <div id="withdrawal-fields" class="hidden">
            <select id="withdrawalCategory">
              <option value="Расходы на продажу">Расходы на продажу</option>
              <option value="Вывод на карту">Вывод на карту</option>
            </select>
            <input id="withdrawalAmount" type="number" step="0.01" placeholder="Сумма (RUB/USDT)" />
            <select id="withdrawalAccount">
              <option value="FunPay">FunPay (RUB)</option>
              <option value="CryptoBot">CryptoBot (USDT)</option>
              <option value="Binance">Binance (USDT)</option>
              <option value="Lolz">Lolz (RUB)</option>
            </select>
            <input id="withdrawalNote" type="text" placeholder="Примечание" />
          </div>
          <input type="hidden" id="editId" />
          <div id="error-message" class="error hidden"></div>
          <button id="submit-btn">Добавить транзакцию</button>
          <button id="cancel-btn" class="hidden">Отменить редактирование</button>
        </div>
      </div>

      <div>
        <h2>История транзакций (<span id="current-month">2025-04</span>)</h2>
        <table>
          <thead>
            <tr>
              <th>Дата</th>
              <th>Тип</th>
              <th>Категория/Счета</th>
              <th>Сумма</th>
              <th>Количество</th>
              <th>Примечание</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody id="transaction-body"></tbody>
        </table>
      </div>
    </div>

    <div id="reports" class="view card hidden">
      <h2>Отчеты (<span id="current-month-reports">2025-04</span>)</h2>
      <div>
        <h3>Балансы счетов</h3>
        <div class="grid" id="balances"></div>
      </div>
      <div>
        <h3>Финансовые показатели</h3>
        <div class="grid">
          <div class="card">
            <p>Доходы от продаж</p>
            <p id="total-income">0.00 RUB</p>
          </div>
          <div class="card">
            <p>Расходы (закупка + продажа)</p>
            <p id="total-expenses">0.00 RUB</p>
          </div>
          <div class="card">
            <p>Прибыль</p>
            <p id="profit">0.00 RUB</p>
          </div>
          <div class="card">
            <p>Средняя покупка</p>
            <p id="avg-purchase">0.00 RUB</p>
          </div>
          <div class="card">
            <p>Средняя продажа</p>
            <p id="avg-sale">0.00 RUB</p>
          </div>
          <div class="card">
            <p>Выводы на карту</p>
            <p id="total-withdrawals">0.00 UZS</p>
            <p id="withdrawal-details">Списано: 0.00 RUB/USDT</p>
          </div>
        </div>
      </div>
      <div>
        <h3>История по месяцам</h3>
        <canvas id="turnoverChart" height="100"></canvas>
        <canvas id="profitChart" height="100"></canvas>
        <canvas id="salesChart" height="100"></canvas>
        <table>
          <thead>
            <tr>
              <th>Месяц</th>
              <th>Оборот (RUB)</th>
              <th>Прибыль (RUB)</th>
              <th>Проданные аккаунты</th>
            </tr>
          </thead>
          <tbody id="monthly-reports"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    // Импорт модулей Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, collection, doc, getDocs, setDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    // Конфигурация Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDQGjhr9RMwiOC27hB1rEipwQWfm8jEjmA",
      authDomain: "raschot-deaa9.firebaseapp.com",
      projectId: "raschot-deaa9",
      storageBucket: "raschot-deaa9.firebasestorage.app",
      messagingSenderId: "664084831389",
      appId: "1:664084831389:web:d12d8fa361b97b0e918874"
    };

    // Инициализация Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    console.log('Firebase initialized:', app.name);

    // XLSX функции
    let gk_isXlsx = false;
    let gk_xlsxFileLookup = {};
    let gk_fileData = {};
    function filledCell(cell) {
      return cell !== '' && cell != null;
    }
    function loadFileData(filename) {
      if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
        try {
          const workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
          const filteredData = jsonData.filter(row => row.some(filledCell));
          let headerRowIndex = filteredData.findIndex((row, index) =>
            row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
          );
          if (headerRowIndex === -1 || headerRowIndex > 25) {
            headerRowIndex = 0;
          }
          const csv = XLSX.utils.sheet_to_csv(XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)), { header: 1 });
          return csv;
        } catch (e) {
          console.error('Ошибка обработки XLSX:', e);
          return "";
        }
      }
      return gk_fileData[filename] || "";
    }

    const accounts = [
      { id: 1, name: 'FunPay', balance: 0, currency: 'RUB' },
      { id: 2, name: 'CryptoBot', balance: 0, currency: 'USDT' },
      { id: 3, name: 'Binance', balance: 0, currency: 'USDT' },
      { id: 4, name: 'Lolz', balance: 0, currency: 'RUB' },
    ];

    const exchangeRates = {
      RUBtoUZS: 130,
      USDTtoUZS: 12700,
      USDTtoRUB: 95,
    };

    let transactions = {};
    let currentMonth = new Date().toISOString().slice(0, 7);
    let currentUser = null;
    let turnoverChart, profitChart, salesChart;

    // Проверка состояния аутентификации
    onAuthStateChanged(auth, user => {
      console.log('Auth state changed:', user ? user.email : 'No user');
      if (user) {
        currentUser = user;
        document.getElementById('auth').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        loadTransactions();
        loadMonths();
        renderTransactions();
      } else {
        currentUser = null;
        transactions = {};
        document.getElementById('auth').classList.remove('hidden');
        document.getElementById('app').classList.add('hidden');
      }
    });

    function login() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      console.log('Login clicked:', email);
      if (!email || !password) {
        showAuthError('Введите email и пароль');
        return;
      }
      signInWithEmailAndPassword(auth, email, password)
        .catch(err => showAuthError('Ошибка входа: ' + err.message));
    }

    function register() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      console.log('Register clicked:', email);
      if (!email || !password) {
        showAuthError('Введите email и пароль');
        return;
      }
      createUserWithEmailAndPassword(auth, email, password)
        .then(() => signInWithEmailAndPassword(auth, email, password))
        .catch(err => showAuthError('Ошибка регистрации: ' + err.message));
    }

    function resetPassword() {
      const email = document.getElementById('email').value.trim();
      console.log('Reset password clicked:', email);
      if (!email) {
        showAuthError('Введите email для сброса пароля');
        return;
      }
      sendPasswordResetEmail(auth, email)
        .then(() => showAuthError('Письмо для сброса пароля отправлено'))
        .catch(err => showAuthError('Ошибка: ' + err.message));
    }

    function logout() {
      console.log('Logout clicked');
      signOut(auth);
    }

    function showAuthError(message) {
      const errorDiv = document.getElementById('auth-error');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => {
        errorDiv.classList.add('hidden');
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
      }, 5000);
    }

    async function loadTransactions() {
      if (!currentUser) return;
      transactions = {};
      try {
        const snapshot = await getDocs(collection(db, 'users', currentUser.uid, 'transactions'));
        snapshot.forEach(doc => {
          const month = doc.id;
          transactions[month] = doc.data().transactions || [];
        });
      } catch (err) {
        console.error('Ошибка загрузки транзакций:', err);
        showAuthError('Ошибка загрузки данных.');
      }
    }

    async function saveTransactions() {
      if (!currentUser) return;
      try {
        for (const month in transactions) {
          await setDoc(doc(db, 'users', currentUser.uid, 'transactions', month), {
            transactions: transactions[month] || []
          });
        }
      } catch (err) {
        console.error('Ошибка сохранения транзакций:', err);
        showAuthError('Ошибка сохранения данных.');
      }
    }

    async function loadMonths() {
      const months = Object.keys(transactions);
      const now = new Date();
      const currentMonthStr = now.toISOString().slice(0, 7);
      const nextMonth = new Date(now.setMonth(now.getMonth() + 1)).toISOString().slice(0, 7);
      if (!months.includes(currentMonthStr)) months.push(currentMonthStr);
      if (!months.includes(nextMonth)) months.push(nextMonth);
      const select = document.getElementById('month-select');
      select.innerHTML = '';
      months.sort((a, b) => b.localeCompare(a)).forEach(month => {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = new Date(`${month}-01`).toLocaleString('ru', { month: 'long', year: 'numeric' });
        if (month === currentMonth) option.selected = true;
        select.appendChild(option);
      });
    }

    async function addNewMonth() {
      const lastMonth = document.getElementById('month-select').options[0].value;
      const [year, month] = lastMonth.split('-').map(Number);
      const nextDate = new Date(year, month, 1);
      nextDate.setMonth(nextDate.getMonth() + 1);
      const newMonth = nextDate.toISOString().slice(0, 7);
      transactions[newMonth] = [];
      await saveTransactions();
      await loadMonths();
      changeMonth(newMonth);
      showError(`Месяц ${nextDate.toLocaleString('ru', { month: 'long', year: 'numeric' })} добавлен.`);
    }

    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => errorDiv.classList.add('hidden'), 5000);
    }

    async function resetData() {
      transactions = {};
      accounts.forEach(acc => acc.balance = 0);
      await saveTransactions();
      await loadMonths();
      renderTransactions();
      showError('Балансы и транзакции сброшены.');
    }

    function showView(view) {
      document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
      document.getElementById(view).classList.remove('hidden');
      document.getElementById('transactions-btn').classList.remove('active');
      document.getElementById('reports-btn').classList.remove('active');
      document.getElementById(`${view}-btn`).classList.add('active');
      if (view === 'reports') updateReports();
      else renderTransactions();
    }

    function changeMonth(month) {
      currentMonth = month;
      document.getElementById('current-month').textContent = month;
      document.getElementById('current-month-reports').textContent = month;
      renderTransactions();
      if (!document.getElementById('reports').classList.contains('hidden')) {
        updateReports();
      }
    }

    function updateWithdrawalAmountPlaceholder() {
      const category = document.getElementById('withdrawalCategory').value;
      const account = document.getElementById('withdrawalAccount').value;
      const accountCurrency = accounts.find(a => a.name === account)?.currency || 'RUB';
      const amountInput = document.getElementById('withdrawalAmount');
      amountInput.placeholder = `Сумма (${accountCurrency})`;
    }

    function toggleFormFields() {
      const type = document.getElementById('type').value;
      const purchaseSaleFields = document.getElementById('purchase-sale-fields');
      const transferFields = document.getElementById('transfer-fields');
      const depositFields = document.getElementById('deposit-fields');
      const withdrawalFields = document.getElementById('withdrawal-fields');
      [purchaseSaleFields, transferFields, depositFields, withdrawalFields].forEach(field => field.classList.add('hidden'));
      if (type === 'Покупка' || type === 'Продажа') {
        purchaseSaleFields.classList.remove('hidden');
      } else if (type === 'Перевод') {
        transferFields.classList.remove('hidden');
      } else if (type === 'Пополнение') {
        depositFields.classList.remove('hidden');
      } else if (type === 'Списание') {
        withdrawalFields.classList.remove('hidden');
        updateWithdrawalAmountPlaceholder();
      }
    }

    function calculateExchangeRate() {
      const amountFrom = parseFloat(document.getElementById('amountFrom').value);
      const amountTo = parseFloat(document.getElementById('amountTo').value);
      const exchangeRateInput = document.getElementById('exchangeRate');
      if (!isNaN(amountFrom) && !isNaN(amountTo) && amountFrom > 0) {
        const rate = amountTo / amountFrom;
        exchangeRateInput.value = rate.toFixed(2);
      } else {
        exchangeRateInput.value = '';
      }
    }

    async function addOrUpdateTransaction() {
      const type = document.getElementById('type').value;
      const editId = document.getElementById('editId').value;
      let trans;
      try {
        if (type === 'Перевод') {
          const amountFrom = parseFloat(document.getElementById('amountFrom').value);
          const amountTo = parseFloat(document.getElementById('amountTo').value);
          const exchangeRate = parseFloat(document.getElementById('exchangeRate').value);
          if (isNaN(amountFrom) || isNaN(amountTo) || isNaN(exchangeRate) || amountFrom <= 0 || amountTo <= 0 || exchangeRate <= 0) {
            throw new Error('Заполните все поля для перевода корректно.');
          }
          trans = {
            month: currentMonth,
            id: editId ? parseInt(editId) : (Math.max(...(transactions[currentMonth] || []).map(t => t.id), 0) + 1),
            date: new Date().toLocaleDateString(),
            type: 'Перевод',
            fromAccount: document.getElementById('fromAccount').value,
            toAccount: document.getElementById('toAccount').value,
            amountFrom,
            amountTo,
            exchangeRate,
            note: document.getElementById('transferNote').value,
          };
        } else if (type === 'Пополнение') {
          const amount = parseFloat(document.getElementById('depositAmount').value);
          if (isNaN(amount) || amount <= 0) {
            throw new Error('Укажите корректную сумму пополнения.');
          }
          trans = {
            month: currentMonth,
            id: editId ? parseInt(editId) : (Math.max(...(transactions[currentMonth] || []).map(t => t.id), 0) + 1),
            date: new Date().toLocaleDateString(),
            type: 'Пополнение',
            amount,
            account: document.getElementById('depositAccount').value,
            note: document.getElementById('depositNote').value,
          };
        } else if (type === 'Списание') {
          const category = document.getElementById('withdrawalCategory').value;
          const account = document.getElementById('withdrawalAccount').value;
          const amount = parseFloat(document.getElementById('withdrawalAmount').value);
          if (isNaN(amount) || amount <= 0) {
            throw new Error('Укажите корректную сумму списания.');
          }
          const accountCurrency = accounts.find(a => a.name === account)?.currency || 'RUB';
          trans = {
            month: currentMonth,
            id: editId ? parseInt(editId) : (Math.max(...(transactions[currentMonth] || []).map(t => t.id), 0) + 1),
            date: new Date().toLocaleDateString(),
            type: 'Списание',
            category,
            amount,
            account,
            amountUZS: category === 'Вывод на карту' ? amount * (accountCurrency === 'RUB' ? exchangeRates.RUBtoUZS : exchangeRates.USDTtoUZS) : null,
            note: document.getElementById('withdrawalNote').value,
          };
        } else {
          const amount = parseFloat(document.getElementById('amount').value);
          const quantity = parseInt(document.getElementById('quantity').value);
          if (isNaN(amount) || amount <= 0) {
            throw new Error('Укажите корректную сумму.');
          }
          trans = {
            month: currentMonth,
            id: editId ? parseInt(editId) : (Math.max(...(transactions[currentMonth] || []).map(t => t.id), 0) + 1),
            date: new Date().toLocaleDateString(),
            type,
            category: document.getElementById('category').value,
            amount,
            account: document.getElementById('account').value,
            quantity: isNaN(quantity) ? null : quantity,
            note: document.getElementById('note').value,
          };
        }

        if (!transactions[currentMonth]) transactions[currentMonth] = [];
        if (editId) {
          const index = transactions[currentMonth].findIndex(t => t.id === parseInt(editId));
          transactions[currentMonth][index] = trans;
        } else {
          transactions[currentMonth].push(trans);
        }
        await saveTransactions();
        await loadMonths();
        renderTransactions();
        resetForm();
      } catch (err) {
        showError('Ошибка сохранения транзакции: ' + err.message);
      }
    }

    function editTransaction(id) {
      const trans = transactions[currentMonth].find(t => t.id === id);
      if (!trans) {
        showError('Транзакция не найдена.');
        return;
      }
      document.getElementById('type').value = trans.type;
      toggleFormFields();
      if (trans.type === 'Перевод') {
        document.getElementById('fromAccount').value = trans.fromAccount;
        document.getElementById('toAccount').value = trans.toAccount;
        document.getElementById('amountFrom').value = trans.amountFrom;
        document.getElementById('amountTo').value = trans.amountTo;
        document.getElementById('exchangeRate').value = trans.exchangeRate;
        document.getElementById('transferNote').value = trans.note;
      } else if (trans.type === 'Пополнение') {
        document.getElementById('depositAmount').value = trans.amount;
        document.getElementById('depositAccount').value = trans.account;
        document.getElementById('depositNote').value = trans.note;
      } else if (trans.type === 'Списание') {
        document.getElementById('withdrawalCategory').value = trans.category;
        document.getElementById('withdrawalAmount').value = trans.amount;
        document.getElementById('withdrawalAccount').value = trans.account;
        document.getElementById('withdrawalNote').value = trans.note;
        updateWithdrawalAmountPlaceholder();
      } else {
        document.getElementById('category').value = trans.category || '';
        document.getElementById('amount').value = trans.amount;
        document.getElementById('account').value = trans.account;
        document.getElementById('quantity').value = trans.quantity || '';
        document.getElementById('note').value = trans.note || '';
      }
      document.getElementById('editId').value = id;
      document.getElementById('form-title').textContent = 'Редактировать транзакцию';
      document.getElementById('submit-btn').textContent = 'Обновить транзакцию';
      document.getElementById('cancel-btn').classList.remove('hidden');
    }

    function cancelEdit() {
      resetForm();
    }

    function resetForm() {
      document.getElementById('type').value = 'Покупка';
      toggleFormFields();
      document.getElementById('category').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('account').value = 'Lolz';
      document.getElementById('quantity').value = '';
      document.getElementById('note').value = '';
      document.getElementById('fromAccount').value = 'CryptoBot';
      document.getElementById('toAccount').value = 'FunPay';
      document.getElementById('amountFrom').value = '';
      document.getElementById('amountTo').value = '';
      document.getElementById('exchangeRate').value = '';
      document.getElementById('transferNote').value = '';
      document.getElementById('depositAmount').value = '';
      document.getElementById('depositAccount').value = 'FunPay';
      document.getElementById('depositNote').value = '';
      document.getElementById('withdrawalCategory').value = 'Расходы на продажу';
      document.getElementById('withdrawalAmount').value = '';
      document.getElementById('withdrawalAccount').value = 'FunPay';
      document.getElementById('withdrawalNote').value = '';
      document.getElementById('editId').value = '';
      document.getElementById('form-title').textContent = 'Добавить транзакцию';
      document.getElementById('submit-btn').textContent = 'Добавить транзакцию';
      document.getElementById('cancel-btn').classList.add('hidden');
      document.getElementById('withdrawalAmount').placeholder = 'Сумма (RUB)';
      document.getElementById('error-message').classList.add('hidden');
    }

    async function deleteTransaction(id) {
      transactions[currentMonth] = transactions[currentMonth].filter(t => t.id !== id);
      if (!transactions[currentMonth].length) delete transactions[currentMonth];
      await saveTransactions();
      renderTransactions();
    }

    function updateAccountBalances() {
      accounts.forEach(acc => {
        acc.balance = 0;
        (transactions[currentMonth] || []).forEach(t => {
          if (t.type === 'Покупка' || t.type === 'Продажа' || t.type === 'Пополнение' || t.type === 'Списание') {
            if (t.account === acc.name) {
              const amount = Number(t.amount);
              if (isNaN(amount)) return;
              acc.balance += (t.type === 'Продажа' || t.type === 'Пополнение') ? amount : -amount;
            }
          } else if (t.type === 'Перевод') {
            if (t.fromAccount === acc.name) {
              const amountFrom = Number(t.amountFrom);
              if (!isNaN(amountFrom)) acc.balance -= amountFrom;
            } else if (t.toAccount === acc.name) {
              const amountTo = Number(t.amountTo);
              if (!isNaN(amountTo)) acc.balance += amountTo;
            }
          }
        });
      });
    }

    function renderTransactions() {
      const tbody = document.getElementById('transaction-body');
      tbody.innerHTML = '';
      (transactions[currentMonth] || []).forEach(t => {
        const row = document.createElement('tr');
        let categoryDisplay = '';
        if (t.type === 'Перевод') {
          categoryDisplay = `${t.fromAccount} → ${t.toAccount}`;
        } else if (t.type === 'Покупка') {
          categoryDisplay = `Покупка с ${t.account} (${t.category || '-'})`;
        } else if (t.type === 'Продажа') {
          categoryDisplay = `Продажа на ${t.account} (${t.category || '-'})`;
        } else if (t.type === 'Пополнение') {
          categoryDisplay = `Пополнение на ${t.account}`;
        } else if (t.type === 'Списание') {
          categoryDisplay = `Списание с ${t.account} (${t.category})`;
        }

        let amountDisplay = '';
        if (t.type === 'Перевод') {
          const fromCurrency = accounts.find(a => a.name === t.fromAccount)?.currency || 'RUB';
          const toCurrency = accounts.find(a => a.name === t.toAccount)?.currency || 'RUB';
          amountDisplay = `${t.amountFrom} ${fromCurrency} → ${t.amountTo} ${toCurrency}`;
        } else if (t.type === 'Списание' && t.category === 'Вывод на карту') {
          const accountCurrency = accounts.find(a => a.name === t.account)?.currency || 'RUB';
          amountDisplay = `${t.amount} ${accountCurrency} (${(t.amountUZS || 0).toFixed(2)} UZS)`;
        } else {
          const accountCurrency = accounts.find(a => a.name === t.account)?.currency || 'RUB';
          amountDisplay = `${t.amount} ${accountCurrency}`;
        }

        row.innerHTML = `
          <td>${t.date}</td>
          <td>${t.type}</td>
          <td>${categoryDisplay}</td>
          <td>${amountDisplay}</td>
          <td>${t.quantity || '-'}</td>
          <td>${t.note || '-'}</td>
          <td>
            <button class="yellow edit-btn" data-id="${t.id}">Редактировать</button>
            <button class="red delete-btn" data-id="${t.id}">Удалить</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      // Привязка событий для кнопок редактирования и удаления
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => editTransaction(parseInt(btn.dataset.id)));
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteTransaction(parseInt(btn.dataset.id)));
      });
    }

    function calculateMonthlyMetrics(month) {
      const purchases = (transactions[month] || []).filter(t => t.type === 'Покупка');
      const sales = (transactions[month] || []).filter(t => t.type === 'Продажа');
      const saleExpenses = (transactions[month] || []).filter(t => t.type === 'Списание' && t.category === 'Расходы на продажу');

      const totalIncome = sales.reduce((sum, t) => {
        const amount = Number(t.amount);
        if (isNaN(amount)) return sum;
        const currency = accounts.find(a => a.name === t.account)?.currency || 'RUB';
        return sum + (currency === 'RUB' ? amount : amount * exchangeRates.USDTtoRUB);
      }, 0);

      const totalPurchaseExpenses = purchases.reduce((sum, t) => {
        const amount = Number(t.amount);
        if (isNaN(amount)) return sum;
        const currency = accounts.find(a => a.name === t.account)?.currency || 'RUB';
        return sum + (currency === 'RUB' ? amount : amount * exchangeRates.USDTtoRUB);
      }, 0);

      const totalSaleExpenses = saleExpenses.reduce((sum, t) => {
        const amount = Number(t.amount);
        if (isNaN(amount)) return sum;
        const currency = accounts.find(a => a.name === t.account)?.currency || 'RUB';
        return sum + (currency === 'RUB' ? amount : amount * exchangeRates.USDTtoRUB);
      }, 0);

      const turnover = totalIncome + totalPurchaseExpenses + totalSaleExpenses;
      const profit = totalIncome - (totalPurchaseExpenses + totalSaleExpenses);
      const soldAccounts = sales.reduce((sum, t) => {
        const quantity = Number(t.quantity);
        return sum + (isNaN(quantity) ? 0 : quantity);
      }, 0);

      return { turnover, profit, soldAccounts };
    }

    function updateReports() {
      updateAccountBalances();
      const balancesDiv = document.getElementById('balances');
      balancesDiv.innerHTML = '';
      accounts.forEach(acc => {
        const balance = acc.balance !== undefined && !isNaN(acc.balance) ? acc.balance : 0;
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <h3>${acc.name}</h3>
          <p>Баланс: ${balance.toFixed(2)} ${acc.currency}</p>
        `;
        balancesDiv.appendChild(div);
      });

      const purchases = (transactions[currentMonth] || []).filter(t => t.type === 'Покупка');
      const sales = (transactions[currentMonth] || []).filter(t => t.type === 'Продажа');
      const saleExpenses = (transactions[currentMonth] || []).filter(t => t.type === 'Списание' && t.category === 'Расходы на продажу');
      const cardWithdrawals = (transactions[currentMonth] || []).filter(t => t.type === 'Списание' && t.category === 'Вывод на карту');

      const totalIncome = sales.reduce((sum, t) => {
        const amount = Number(t.amount);
        if (isNaN(amount)) return sum;
        const currency = accounts.find(a => a.name === t.account)?.currency || 'RUB';
        return sum + (currency === 'RUB' ? amount : amount * exchangeRates.USDTtoRUB);
      }, 0);

      const totalPurchaseExpenses = purchases.reduce((sum, t) => {
        const amount = Number(t.amount);
        if (isNaN(amount)) return sum;
        const currency = accounts.find(a => a.name === t.account)?.currency || 'RUB';
        return sum + (currency === 'RUB' ? amount : amount * exchangeRates.USDTtoRUB);
      }, 0);

      const totalSaleExpenses = saleExpenses.reduce((sum, t) => {
        const amount = Number(t.amount);
        if (isNaN(amount)) return sum;
        const currency = accounts.find(a => a.name === t.account)?.currency || 'RUB';
        return sum + (currency === 'RUB' ? amount : amount * exchangeRates.USDTtoRUB);
      }, 0);

      const totalExpenses = totalPurchaseExpenses + totalSaleExpenses;
      const profit = totalIncome - totalExpenses;
      const avgPurchase = purchases.length ? totalPurchaseExpenses / purchases.length : 0;
      const avgSale = sales.length ? totalIncome / sales.length : 0;
      const totalCardWithdrawalsUZS = cardWithdrawals.reduce((sum, t) => {
        const amountUZS = Number(t.amountUZS);
        if (isNaN(amountUZS)) return sum;
        return sum + amountUZS;
      }, 0);

      const withdrawalDetails = cardWithdrawals.map(t => {
        const amount = Number(t.amount);
        if (isNaN(amount)) return '0.00 RUB';
        return `${amount.toFixed(2)} ${accounts.find(a => a.name === t.account)?.currency || 'RUB'}`;
      }).join(', ');

      document.getElementById('total-income').textContent = `${(isNaN(totalIncome) ? 0 : totalIncome).toFixed(2)} RUB`;
      document.getElementById('total-expenses').textContent = `${(isNaN(totalExpenses) ? 0 : totalExpenses).toFixed(2)} RUB`;
      document.getElementById('profit').textContent = `${(isNaN(profit) ? 0 : profit).toFixed(2)} RUB`;
      document.getElementById('avg-purchase').textContent = `${(isNaN(avgPurchase) ? 0 : avgPurchase).toFixed(2)} RUB`;
      document.getElementById('avg-sale').textContent = `${(isNaN(avgSale) ? 0 : avgSale).toFixed(2)} RUB`;
      document.getElementById('total-withdrawals').textContent = `${(isNaN(totalCardWithdrawalsUZS) ? 0 : totalCardWithdrawalsUZS).toFixed(2)} UZS`;
      document.getElementById('withdrawal-details').textContent = `Списано: ${withdrawalDetails || '0.00 RUB/USDT'}`;

      const months = Object.keys(transactions).sort();
      const monthlyData = months.map(month => ({
        month,
        label: new Date(`${month}-01`).toLocaleString('ru', { month: 'long', year: 'numeric' }),
        ...calculateMonthlyMetrics(month)
      }));

      const monthlyReports = document.getElementById('monthly-reports');
      monthlyReports.innerHTML = '';
      monthlyData.forEach(data => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${data.label}</td>
          <td>${data.turnover.toFixed(2)} RUB</td>
          <td>${data.profit.toFixed(2)} RUB</td>
          <td>${data.soldAccounts}</td>
        `;
        monthlyReports.appendChild(row);
      });

      if (turnoverChart) turnoverChart.destroy();
      if (profitChart) profitChart.destroy();
      if (salesChart) salesChart.destroy();

      turnoverChart = new Chart(document.getElementById('turnoverChart'), {
        type: 'bar',
        data: {
          labels: monthlyData.map(d => d.label),
          datasets: [{
            label: 'Оборот (RUB)',
            data: monthlyData.map(d => d.turnover),
            backgroundColor: '#3b82f6',
            borderColor: '#2563eb',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, grid: { color: '#555555' }, ticks: { color: '#e0e0e0' } },
            x: { grid: { display: false }, ticks: { color: '#e0e0e0' } }
          },
          plugins: {
            legend: { labels: { color: '#e0e0e0' } },
            title: { display: true, text: 'Оборот по месяцам', color: '#ffffff' }
          }
        }
      });

      profitChart = new Chart(document.getElementById('profitChart'), {
        type: 'bar',
        data: {
          labels: monthlyData.map(d => d.label),
          datasets: [{
            label: 'Прибыль (RUB)',
            data: monthlyData.map(d => d.profit),
            backgroundColor: '#10b981',
            borderColor: '#059669',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, grid: { color: '#555555' }, ticks: { color: '#e0e0e0' } },
            x: { grid: { display: false }, ticks: { color: '#e0e0e0' } }
          },
          plugins: {
            legend: { labels: { color: '#e0e0e0' } },
            title: { display: true, text: 'Прибыль по месяцам', color: '#ffffff' }
          }
        }
      });

      salesChart = new Chart(document.getElementById('salesChart'), {
        type: 'bar',
        data: {
          labels: monthlyData.map(d => d.label),
          datasets: [{
            label: 'Проданные аккаунты',
            data: monthlyData.map(d => d.soldAccounts),
            backgroundColor: '#f59e0b',
            borderColor: '#d97706',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, grid: { color: '#555555' }, ticks: { color: '#e0e0e0' } },
            x: { grid: { display: false }, ticks: { color: '#e0e0e0' } }
          },
          plugins: {
            legend: { labels: { color: '#e0e0e0' } },
            title: { display: true, text: 'Проданные аккаунты по месяцам', color: '#ffffff' }
          }
        }
      });
    }

    // Привязка событий
    document.getElementById('login-btn').addEventListener('click', login);
    document.getElementById('register-btn').addEventListener('click', register);
    document.getElementById('reset-password-btn').addEventListener('click', resetPassword);
    document.getElementById('logout-btn').addEventListener('click', logout);
    document.getElementById('transactions-btn').addEventListener('click', () => showView('transactions'));
    document.getElementById('reports-btn').addEventListener('click', () => showView('reports'));
    document.getElementById('month-select').addEventListener('change', e => changeMonth(e.target.value));
    document.getElementById('add-month-btn').addEventListener('click', addNewMonth);
    document.getElementById('reset-data-btn').addEventListener('click', resetData);
    document.getElementById('submit-btn').addEventListener('click', addOrUpdateTransaction);
    document.getElementById('cancel-btn').addEventListener('click', cancelEdit);
    document.getElementById('type').addEventListener('change', toggleFormFields);
    document.getElementById('withdrawalCategory').addEventListener('change', updateWithdrawalAmountPlaceholder);
    document.getElementById('withdrawalAccount').addEventListener('change', updateWithdrawalAmountPlaceholder);
    document.getElementById('amountFrom').addEventListener('input', calculateExchangeRate);
    document.getElementById('amountTo').addEventListener('input', calculateExchangeRate);
  </script>
</body>
</html>